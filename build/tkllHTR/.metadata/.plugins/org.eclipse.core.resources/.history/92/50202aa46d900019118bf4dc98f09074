#include <stdio.h>
#include "xil_printf.h"
#include "xuartps.h"
#include "xparameters.h"
#include "sleep.h"

#define BUFFER_SIZE 	5

XUartPs Uart; // Instance of the UART Device

static u8 SendBuffer[BUFFER_SIZE];	// Buffer for Transmitting Data
static u8 RecvBuffer[BUFFER_SIZE];	// Buffer for Receiving Data

int main(){
	int Index;
	int RecvBytes;
	XUartPs_Config* Config = XUartPs_LookupConfig(XPAR_XUARTPS_0_DEVICE_ID);
	XUartPs_CfgInitialize(&Uart, Config, Config->BaseAddress);

	//XUartPs_SetRecvTimeout(&Uart, 8);

	for (Index = 0 ; Index < BUFFER_SIZE ; Index++){
		SendBuffer[Index] = (Index % 26) + 'A';
		RecvBuffer[Index] = 0;
	}

	XUartPs_Send(&Uart, SendBuffer, BUFFER_SIZE);
	while(1){
		while (!XUartPs_IsReceiveData(XPAR_XUARTPS_0_BASEADDR));
		usleep(100);
		RecvBytes = XUartPs_Recv(&Uart, RecvBuffer, BUFFER_SIZE);
		xil_printf("\n\rNumber of bytes received: %d\n\r", RecvBytes);
		XUartPs_Send(&Uart, RecvBuffer, BUFFER_SIZE);
		for (Index = 0 ; Index < BUFFER_SIZE ; Index++) RecvBuffer[Index] = 0;
	}
	return 0;
}
