#include "xparameters.h"
#include "xstatus.h"
#include "xil_types.h"
#include "xil_assert.h"
#include "xuartps_hw.h"
#include "xil_printf.h"

/************************** Constant Definitions ***************************/

/*
 * The following constants map to the XPAR parameters created in the
 * xparameters.h file. They are defined here such that a user can easily
 * change all the needed parameters in one place.
 */
#define UART_BASEADDR		XPAR_XUARTPS_0_BASEADDR
#define UART_CLOCK_HZ		XPAR_XUARTPS_0_CLOCK_HZ
/*
 * The following constant controls the length of the buffers to be sent
 * and received with the device. This constant must be 32 bytes or less so the
 * entire buffer will fit into the TX and RX FIFOs of the device.
 */
#define BUFFER_SIZE	16

#define CHAR_ESC			0x1b	/* 'ESC' character is used as terminator */

#define IDLE_STATE_1		1
#define IDLE_STATE_2		2
#define IDLE_STATE_3		3
#define IDLE_STATE_4		4
#define IDLE_STATE_5		5
#define IDLE_STATE_6		6
#define EXECUTION_STATE		7
#define RESULT_STATE		8

/************************** Variable Definitions ***************************/

/*
 * The following buffers are used in this example to send and receive data
 * with the UART.
 */
u8 SendBuffer[BUFFER_SIZE];	/* Buffer for Transmitting Data */

int main(){
	int state = IDLE_STATE_1;
	u8 Running = TRUE;
	int Index;
	int InputSize;
	u8 RecvChar;
	u32 CntrlRegister;

	CntrlRegister = XUartPs_ReadReg(UART_BASEADDR, XUARTPS_CR_OFFSET);

	/* Enable TX and RX for the device */
	XUartPs_WriteReg(UART_BASEADDR, XUARTPS_CR_OFFSET,
			  ((CntrlRegister & ~XUARTPS_CR_EN_DIS_MASK) |
			   XUARTPS_CR_TX_EN | XUARTPS_CR_RX_EN));

	while (Running) {
		switch (state){
			case IDLE_STATE_1:
				InputSize = 0;
				/* Wait until there is data */
				while (!XUartPs_IsReceiveData(UART_BASEADDR));
				for (int i = 0 ; i < 6 ; ++i){
					RecvChar = XUartPs_ReadReg(UART_BASEADDR, XUARTPS_FIFO_OFFSET);
					SendBuffer[InputSize++] = RecvChar;
				}
				state = IDLE_STATE_2;
				break;
			case IDLE_STATE_2:
				break;
			case IDLE_STATE_3:
				break;
			case IDLE_STATE_4:
				break;
			case IDLE_STATE_5:
				break;
			case IDLE_STATE_6:
				break;
			case EXECUTION_STATE:
				xil_printf("Input size: %d\n\r", InputSize);
				for (Index = 0 ; Index < InputSize ; ++Index)
					SendBuffer[Index] = SendBuffer[Index] + 2;
				state = RESULT_STATE;
				break;
			case RESULT_STATE:
				/* Echo the character back */
				for (Index = 0 ; Index < InputSize ; ++Index)
					XUartPs_WriteReg(UART_BASEADDR,  XUARTPS_FIFO_OFFSET, SendBuffer[Index]);
				state = IDLE_STATE;
				break;
		}
	}
	return 0;
}
